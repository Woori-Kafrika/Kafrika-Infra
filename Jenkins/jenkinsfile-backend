pipeline {
  agent any

  options {
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '20'))
    skipDefaultCheckout(true)
  }

  // GitHub Webhook을 이미 연결했다면 유지하세요.
  // Webhook을 아직 안 쓴다면 아래 triggers 블록은 삭제해도 됩니다.
  triggers {
    githubPush()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Check Java') {
      steps {
        sh 'echo "JAVA_HOME=$JAVA_HOME"'
        sh 'java -version || true'
      }
    }

    stage('Prepare') {
      steps {
        sh 'chmod +x gradlew || true'
      }
    }

    stage('Build & Test') {
      steps {
        sh './gradlew clean test jacocoTestReport build --no-daemon'
      }
    }

    stage('Publish Test Reports') {
      steps {
        junit allowEmptyResults: true, testResults: 'build/test-results/test/*.xml'
      }
    }

    stage('Archive Artifacts') {
      steps {
        archiveArtifacts artifacts: 'build/libs/*.jar', fingerprint: true
      }
    }
  }

  post {
    always {
      echo "Build finished: ${currentBuild.currentResult}"
    }
  }
}
