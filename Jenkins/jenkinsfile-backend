pipeline {
  agent any

  options {
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '20'))
    skipDefaultCheckout(true)
  }

  triggers {
    // 원하면 Webhook 연결 후 주석 해제
    // githubPush()
  }

  tools {
    // Jenkins > Global Tool Configuration 에 미리 JDK 17(또는 11) 등록해 두세요. (예: temurin-17)
    jdk 'temurin-17'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Prepare') {
      steps {
        sh 'chmod +x gradlew || true'
      }
    }

    stage('Build & Test') {
      steps {
        sh './gradlew clean test jacocoTestReport build --no-daemon'
      }
    }

    stage('Publish Test Reports') {
      steps {
        junit allowEmptyResults: true, testResults: 'build/test-results/test/*.xml'
      }
    }

    stage('Archive Artifacts') {
      steps {
        // JAR 위치는 프로젝트 구조에 맞게 조정
        archiveArtifacts artifacts: 'build/libs/*.jar', fingerprint: true
      }
    }
  }

  post {
    always {
      echo "Build finished: ${currentBuild.currentResult}"
    }
  }
}
